\subsection{Election phase} \label{sec: election phase}
The election phase lasts from the start date until the end date of a voting round. During this time, any voter $\mathcal{V}_i \in \boldsymbol{\mathcal{V}}$ can cast a valid digital ballot by performing the following steps:
\begin{itemize}
    \item get a list with all configuration items of the bulletin board $\alpha_\mathrm{cnf}$ from the digital ballot box,
    \item authenticate and get authorized to cast a digital ballot on the bulletin board as described in \cref{sec: voter authentication procedure},
    \item select vote choices and prepare them for encryption as described in \cref{sec: mapping vote options on the elliptic curve},
    \item encrypt the ballot following the process from \cref{sec: vote cryptogram generation process},
    \item optionally, perform an audit/verification on the encrypted ballot as described in \cref{sec: challenging a vote cryptogram} and
    \item finally, cast the encrypted ballot and obtain a vote confirmation receipt as in \cref{sec: vote confirmation receipt}.
\end{itemize}


\subsubsection{Voter authentication procedure} \label{sec: voter authentication procedure}
A voter $\mathcal{V}_i$ is considered authorized to cast a digital ballot when it is in possession of a secret signing key $x_i$ that corresponds to an eligible public key $Y_i$ from the bulletin board. This is achieved differently depending on the voter authentication mode.


\paragraph{When pre-election voter authentication mode}\mbox{}\\
Each voter $\mathcal{V}_i$ has to input in the voting application all credentials received from the Printing Authorities $x_{i, j}$, with $j \in \{ 1, ..., n_\mathrm{p} \}$. The application combines all credentials to form the voter's secret signing key $x_i = \sum_{j=1}^{n_\mathrm{p}} x_{i, j} \pmod q$. The associated public key $Y_i$ has been computed and included on the bulletin board in the pre-election phase.


\paragraph{When on-demand voter athentication mode}\mbox{}\\
Each voter $\mathcal{V}_i$ has to follow the protocol from \cref{fig: voter authentication protocol} in order to get authorized to cast a digital ballot on the bulletin board. Specifically, the voter must authenticate and get identity tokens $\sigma_{\mathrm{id}, j}$ from all of the idenitity providers $\mathcal{I}_j \in \boldsymbol{\mathcal{I}}$ that have been configured by the voter authorizer in the pre-election phase.

Then, the voting application generates a key pair $(x_i, Y_i) \gets \mathsf{KeyGen}()$ (\cref{alg: key gen}) and forwards all identity tokens $\{ \sigma_{\mathrm{id}, 1}, ..., \sigma_{\mathrm{id}, n_\mathrm{i}} \}$ and the public key $Y_i$ to the voter authorizer service $\mathcal{A}$ proving the identity of the voter $\mathcal{V}_i$.

If the voter authorizer service can validate all identity tokens and the voter is eligible, i.e. $\mathcal{V}_i \in \boldsymbol{\mathcal{V}}$, then it will authorize the use of the public key $Y_i$ for the voter $\mathcal{V}_i$. This is done by the voter authorizer $\mathcal{A}$ interacting with the digital ballot box $\mathcal{D}$ in the protocol \ref{pro: write on board} $\mathtt{WriteOnBoard}(\mathcal{A}, m_\mathrm{vs}, c_\mathrm{vs}, p_\mathrm{vs})$ to write a voter session item $b_\mathrm{vs}$ on the bulletin board as the next item, according to the rules specified in \cref{app: bulletin board item types}, where $m_\mathrm{vs} =$ "voter session", the parent $p_\mathrm{vs}$ is the address of the latest configuration item and the content $c_\mathrm{vs}$ consists of the voter identifier, the public key $Y_i$, and the authentication fingerprint which is the hash value of all identity tokens received form the voter. 

The voter authorizer returns to the voter the voter session item $b_\mathrm{vs}$ as received from the digital ballot box. The voting application checks the item according to the validations of protocol \ref{pro: write on board}. Additionally, it checks that the item is consistent according to the configuration ancestry $\alpha_\mathrm{cnf}$ (i.e. $\mathsf{AncestryVer}(\{ b_\mathrm{vs} \}, h_\mathrm{cnf})$, where $h_\mathrm{cnf}$ is the address of the last item in $\alpha_\mathrm{cnf}$). From this point on, the voter can interact directly with the digital ballot box as the identity $\mathcal{V}_i$.

The voter authorizer service stores a link between the voter identity $\mathcal{V}_i$ and all related identity tokens for the purpose of the private auditing process in the post-election phase as described in \cref{sec: private auditing process}. This link is stored privately by the voter authorizer service due to the fact that the identity tokens likely contain personal information that must not be disclosed on the public bulletin board.

\clearpage
\begin{landscape}
\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[framed,
            node distance=0,
            % every node/.style={draw},
            ]{
        
        % Actors
        \node[title_3, above, anchor=north east] (v) {
            \textbf{Voter $\mathcal{V}_i$}};
        \node[title_3, right=of v] (va) {
            \textbf{Voter Authorizer $\mathcal{A}$}};
        \node[title_3, right=of va] (ip) {
            \textbf{Identity Provider $\mathcal{I}_j$}};
        
        % internal knowledge
        \node[internal_3, below=of v] (v_ik) {
            internal knowledge: $Y_\mathcal{A}$, $Y_\mathcal{D}$, \\
            $\{ Y_{\mathcal{I}_1}, ..., Y_{\mathcal{I}_{n_\mathrm{i}}} \}$, $\alpha_\mathrm{cnf}$
            };
        \node[internal_3, below=of va] (va_ik) {
            internal knowledge: $x_\mathcal{A}$, $\boldsymbol{\mathcal{V}}$, \\
            $\{ Y_{\mathcal{I}_1}, ..., Y_{\mathcal{I}_{n_\mathrm{i}}} \}$, $\alpha_\mathrm{cnf}$
            };
        \node[internal_3, below=of ip] (ip_ik) {
            internal knowledge: $x_{\mathcal{I}_j}$
            };
        
        % All content
        \node[arrow, towards_right, spaced, between={v.center}{ip.center}] at (v_ik.south -| v.center) (a_1) {
            authenticate as $\mathcal{V}_i$
            };
        \node[block, keep_middle, spaced] at (a_1.south -| ip.center) (ip_1) {
            $\sigma_{\mathrm{id}, j} \gets \mathsf{Sign}(x_{\mathcal{I}_j}; \mathcal{V}_i)$
            };
        \node[arrow, towards_left, immediate, between={v.center}{ip.center}] at (ip_1.south -| v.center) (a_2) {
            $\sigma_{\mathrm{id}, j}$
            };
        \node[block, keep_left, spaced] at (a_2.south -| v.west) (v_1) {
            verify that $\mathsf{SigVer}(Y_{\mathcal{I}_j}, \sigma_{\mathrm{id}, j}; \mathcal{V}_i)$
            };
        \node[banner, keep_left, spaced, between={v.west}{ip.east}] at (v_1.south -| v.west) (b_1) {
            when successfully authenticated with all $\mathcal{I}_j \in \boldsymbol{\mathcal{I}}$ and received $\{ \sigma_{\mathrm{id}, 1}, ..., \sigma_{\mathrm{id}, n_\mathrm{i}} \}$
            };
        \node[block, keep_middle, spaced] at (b_1.south -| v.center) (v_2) {
            $(x_i, Y_i) \gets \mathsf{KeyGen}()$
            };
        \node[arrow, towards_right, immediate, between={v.center}{va.center}] at (v_2.south -| v.center) (a_3) {
            \hspace{30pt} $Y_i, \{ \sigma_{\mathrm{id}, 1}, ..., \sigma_{\mathrm{id}, n_\mathrm{i}} \}$
            };
        \node[block, keep_left, spaced] at (a_3.south -| va.west) (va_1) {
            verify that $\mathcal{V}_i \in \boldsymbol{\mathcal{V}}$ and $\mathsf{SigVer}(Y_{\mathcal{I}_j}, \sigma_{\mathrm{id}, j}; \mathcal{V}_i)$, with $j \in \{1, ..., n_\mathrm{i}\}$ then: \\ [7pt]
            $\phi \gets \mathcal{H}(\sigma_{\mathrm{id}, 1} || ... || \sigma_{\mathrm{id}, n_\mathrm{i}})$, $c_\mathrm{vs} \gets (\mathcal{V}_i, Y_i, \phi)$ \\
            $m_\mathrm{vs} \gets$ "voter session", $p_\mathrm{vs} \gets$ the address of the latest item from $\alpha_\mathrm{cnf}$ \\ [7pt]
            \scriptsize $\mathcal{A}$ and $\mathcal{D}$ perform protocol \ref{pro: write on board} to write $b_\mathrm{vs}$ as the next item of the bulletin board \\ [-2pt]
            \scriptsize $(b_\mathrm{vs}, \rho_\mathrm{vs}) \gets \mathtt{WriteOnBoard}(\mathcal{A}, m_\mathrm{vs}, c_\mathrm{vs}, p_\mathrm{vs})$ \\ [7pt]
            internally store the tuple for auditing: $(\mathcal{V}_i, \phi, \{ \sigma_{\mathrm{id}, 1}, ..., \sigma_{\mathrm{id}, n_\mathrm{i}} \})$
            };
        \node[arrow, towards_left, immediate, between={v.center}{va.center}] at (va_1.south -| v.center) (a_4) {
            $b_\mathrm{vs}$ \hspace{70pt}
            };
        \node[block, keep_left, spaced] at (a_4.south -| v.west) (v_3) {
            $h_\mathrm{cnf} \gets $ the address of the latest item in $\alpha_\mathrm{cnf}$ \\
            verify $\mathsf{AncestryVer}(\{ b_\mathrm{vs} \}, h_\mathrm{cnf})$, $\mathsf{ItemVer}(b_\mathrm{vs}, Y_\mathcal{A})$ \\
            and that $c_\mathrm{vs} = (\mathcal{V}_i, Y_i, \mathcal{H}(\sigma_{\mathrm{id}, 1} || ... || \sigma_{\mathrm{id}, n_\mathrm{i}}))$
            };
        
        % Arrows and lines
        \draw[dashed] (v.south west)--(ip.south east);    
        \draw[dashed] (v_ik.west |- va_ik.south)--(ip_ik.east |- va_ik.south);
        
        \draw[dotted] (b_1.north west)--(b_1.north east);
        \draw[dotted] (b_1.south west)--(b_1.south east);
        
        \draw[densely dotted] (v_ik.south)--(v_1.north -| v.center);
        \draw[densely dotted] (v_1.south -| v.center)--(b_1.north -| v.center);
        \draw[densely dotted] (b_1.south -| v.center)--(v_2.north -| v.center);
        \draw[densely dotted] (v_2.south -| v.center)--(v_3.north -| v.center);

        \draw[densely dotted] (a_3.south -| va.center)--(va_1.north -| va.center);
        \draw[densely dotted] (va_1.south -| va.center)--(a_4.south -| va.center);

        \draw[densely dotted] (a_1.south -| ip.center)--(ip_1.north -| ip.center);
        \draw[densely dotted] (ip_1.south -| ip.center)--(a_2.south -| ip.center);
        }
    \end{tikzpicture}
    \caption{Voter authentication protocol}
    \label{fig: voter authentication protocol}
\end{figure}
\end{landscape}


\clearpage
\subsubsection{Mapping vote options on the Elliptic Curve} \label{sec: mapping vote options on the elliptic curve}
An expressed vote (a vote in plain text) must be able to be converted, deterministically, into an elliptic curve point in order to be used in our cryptographic protocols. Additionally, a point from the elliptic curve must be able to be turned back to a plain text vote, if the point has been constructed from a plain text. Depending on the election type (referendum, simple election, multiple choice election, STV election), the plain text vote can be constructed in different ways, for example a simple string, or an array of integers or even a complex data structure. Regardless of the vote encoding rules, the plin text vote is converted into its byte representation $\boldsymbol{b} \in \mathbb{B}^*$.

Next, $\boldsymbol{b}$ is converted into an elliptic curve point $V \gets \mathsf{Bytes2Point}(\boldsymbol{b})$ (\cref{alg: bytes to point}), which can be used further in the encryption mechanism described in \cref{sec: vote cryptogram generation process}. Thus, point $M$ is the representation of voter's vote choices in cryptographic form.

Recovering the byte array $\boldsymbol{b}$ from $V$ can be done by $\boldsymbol{b} \gets \mathsf{Point2Bytes}(V)$ (\cref{alg: point to bytes}), which can further be decoded into a plain text vote, depending on the vote encoding rules.


\subsubsection{Vote cryptogram generation process} \label{sec: vote cryptogram generation process}
During the vote cryptogram generation process, the voting application collaborates with the digital ballot box $\mathcal{D}$ for generating the cryptogram $e$ that represents the encryption of the vote $M$. This process results in the fact that neither the voter $\mathcal{V}_i$ nor the digital ballot box $\mathcal{D}$ will be in possession of whole randomizer value $r$ used in the generation process of cryptogram $e$ (recall from \cref{app: elgamal cryptosystem} that $e = \mathsf{Enc}(Y_\mathrm{enc}, M; r)$). That is achieved by both the voter and the digital ballot box building up the randomizer but none of them knowing its entire value. It is important for the voter to not know this value in order to not be able to produce cryptographic evidence of the way he voted (as in \cref{app: proving the content of a cryptogram}), thus achieving \textit{receipt freeness}. The entire process cosists of commiting to the encryption randomizers which is presented in \cref{fig: encryption commitments submission protocol} and submitting the encrypted ballot as presented in \cref{fig: encrypted ballot submission protocol}.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[framed,
            node distance=0,
            % every node/.style={draw}
            ]{
            
        % Actors
        \node[title, above, anchor=north east] (v) {
            \textbf{Voter $\mathcal{V}_i$}};
        \node[title, right=of v] (dbb) {
            \textbf{Digital Ballot Box $\mathcal{D}$}};
        
        % internal knowledge
        \node[internal, below=of v] (v_ik) {
            internal knowledge: $x_i$, $Y_\mathcal{D}$, \\
            $\alpha_\mathrm{vs} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vs} \}$
            };
        \node[internal, below=of dbb] (dbb_ik) {
            internal knowledge: $x_\mathcal{D}$, $Y_\mathrm{enc}$, \\
            $\boldsymbol{b} = \{ b_1, ..., b_{k-1} \}$
            };
        
        %All content
        \node[block, keep_left, spaced] at (dbb_ik.south -| v_ik.west) (v_1) {
            $r_\mathrm{v} \in_\mathrm{R} \mathbb{Z}_q$, $s_\mathrm{v} \in_\mathrm{R} \mathbb{Z}_q$ \\
            $c_\mathrm{vec} \gets \mathsf{Com}(r_\mathrm{v}, s_\mathrm{v})$, $p_\mathrm{vec} \gets$ the address of $b_\mathrm{vs}$ \\
            $m_\mathrm{vec} \gets$ "voter encryption commitment"
            };
        \node[banner, keep_left, spaced, between={v.west}{dbb.east}] at (v_1.south west) (b_1) {
            $\mathcal{V}_i$ and $\mathcal{D}$ perform protocol \ref{pro: write on board} to write $b_\mathrm{vec}$ as the $k^\mathrm{th}$ item of $\boldsymbol{b}$ \\
            $(b_\mathrm{vec}, \rho_\mathrm{vec}) \gets \mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{vec}, c_\mathrm{vec}, p_\mathrm{vec})$, therefore $b_\mathrm{vec} \in \boldsymbol{b}$
            };
        \node[block, keep_right, spaced] at (b_1.south east) (dbb_1) {
            $r_\mathrm{d} \in_\mathrm{R} \mathbb{Z}_q$, $s_\mathrm{d} \in_\mathrm{R} \mathbb{Z}_q$ \\
            $c_\mathrm{sec} \gets \mathsf{Com}(r_\mathrm{d}, s_\mathrm{d})$, $p_\mathrm{sec} \gets$ the address of $b_\mathrm{vec}$ \\
            $m_\mathrm{sec} \gets$ "server encryption commitment" \\ [7pt]
            \scriptsize perform protocol \ref{pro: write on board} to write $b_\mathrm{sec}$ as the $(k+1)^\mathrm{th}$ item of $\boldsymbol{b}$ \\ [-2pt]
            \scriptsize $(b_\mathrm{sec}, \rho_\mathrm{sec}) \gets \mathtt{WriteOnBoard}(\mathcal{D}, m_\mathrm{sec}, c_\mathrm{sec}, p_\mathrm{sec})$, \\[-2pt] 
            \scriptsize therefore $b_\mathrm{sec} \in \boldsymbol{b}$ \\ [7pt]
            $e_\mathrm{d} \gets \mathsf{Enc}(Y_\mathrm{enc}, \mathcal{O}; r_\mathrm{d})$
            };
        \node[arrow, towards_left, between={v.center}{dbb.center}] at (dbb_1.south -| v.center) (a_1) {
            $(b_\mathrm{vec}, \rho_\mathrm{vec})$, $(b_\mathrm{sec}, \rho_\mathrm{sec})$, $e_\mathrm{d}$
            };
        \node[block, keep_left, spaced] at (a_1.south -| v.west) (v_2) {
            $h_\mathrm{vs} \gets $ the address of $b_\mathrm{vs}$ \\
            verify $\mathsf{AncestryVer}(\{ b_\mathrm{vec}, b_\mathrm{sec} \}, h_\mathrm{vs})$ \\
            and $\mathsf{ItemVer}(b_\mathrm{sec}, Y_\mathcal{D})$
            };
        
        % Arrows and lines
        \draw[dashed] (v.south west)--(dbb.south east);    
        \draw[dashed] (dbb_ik.south -| v.west)--(dbb_ik.south east);

        \draw[dotted] (b_1.north west)--(b_1.north east);
        \draw[dotted] (b_1.south west)--(b_1.south east);

        \draw[densely dotted] (v_1.south -| v.center)--(b_1.north -| v.center);
        \draw[densely dotted] (b_1.south -| v.center)--(v_2.north -| v.center);

        \draw[densely dotted] (b_1.south -| dbb.center)--(dbb_1.north -| dbb.center);
        \draw[densely dotted] (dbb_1.south -| a_1.east)--(a_1.south east);
        }
    \end{tikzpicture}
    \caption{Encryption commitments submission protocol}
    \label{fig: encryption commitments submission protocol}
\end{figure}

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[framed,
            node distance=0,
            % every node/.style={draw}
            ]{
            
        % Actors
        \node[title, above, anchor=north east] (v) {
            \textbf{Voter $\mathcal{V}_i$}};
        \node[title, right=of v] (dbb) {
            \textbf{Digital Ballot Box $\mathcal{D}$}};
        
        % internal knowledge
        \node[internal, below=of v] (v_ik) {
            internal knowledge: $x_i$, $Y_\mathcal{D}$, $Y_\mathrm{enc}$, \\
            $\alpha_\mathrm{sec} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vec}, b_\mathrm{sec} \}$, $M$, $r_\mathrm{v}$, $e_\mathrm{d}$
            };
        \node[internal, below=of dbb] (dbb_ik) {
            internal knowledge: $x_\mathcal{D}$, $Y_\mathrm{enc}$, $r_\mathrm{d}$, \\
            $\boldsymbol{b'} = \{ b_1, ..., b_{k'-1} \}$
            };
        
        %All content
        \node[block, spaced, keep_left] at (v_ik.south west) (v_1) {
            $e_\mathrm{v} \gets \mathsf{Enc}(Y_\mathrm{enc}, M; r_\mathrm{v})$ \\
            $e \gets \mathsf{HomAdd}(e_\mathrm{d}, e_\mathrm{v})$ \\
            $PK \gets \mathsf{DLProve}(r_\mathrm{v}, \{ G \})$ \\
            $c_\mathrm{bc} \gets e$, $p_\mathrm{bc} \gets$ address of $b_\mathrm{sec}$ \\
            $m_\mathrm{bc} \gets$ "ballot cryptograms"
            };
        \node[arrow, towards_right, immediate, between={v.center}{dbb.center}] at (v_1.south -| v.center) (a_1) {
            \hspace{40pt} $e = (R, C)$, $PK$
            };
        \node[block, keep_right, spaced] at (a_1.south -| dbb.east) (dbb_1) {
            verify that $\mathsf{DLVer}(PK, \{ G \}; \{ R - [r_\mathrm{d}]G \})$
            };
        \node[banner, keep_left, spaced, between={v.west}{dbb.east}] at (dbb_1.south -| v.west) (b_1) {
            $\mathcal{V}_i$ and $\mathcal{D}$ perform protocol \ref{pro: write on board} to write $b_\mathrm{bc}$ as the ${k'}^\mathrm{th}$ item of $\boldsymbol{b}$ \\
            $(b_\mathrm{bc}, \rho_\mathrm{bc}) \gets \mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{bc}, c_\mathrm{bc}, p_\mathrm{bc})$, therefore $b_\mathrm{bc} \in \boldsymbol{b}$
            };
        \node[block, keep_right, spaced] at (b_1.south east) (dbb_2) {
            $c_\mathrm{vts} \gets \varnothing$, $p_\mathrm{vts} \gets$ the address of $b_\mathrm{bc}$ \\
            $m_\mathrm{vts} \gets$ "verification track start" \\ [7pt]
            \scriptsize perform protocol \ref{pro: write on board} to write $b_\mathrm{vts}$ as the first item on the \\ [-2pt]
            \scriptsize hidden track introduced by the ballot cryptograms item $\boldsymbol{b}^{b_\mathrm{bc}}$ \\ [-2pt]
            \scriptsize $(b_\mathrm{vts}, \rho_\mathrm{vts}) \gets \mathtt{WriteOnBoard}(\mathcal{D}, m_\mathrm{vts}, c_\mathrm{vts}, p_\mathrm{vts})$, \\ [-2pt]
            \scriptsize therefore $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts} \}$
            };
        \node[arrow, towards_left, between={v.center}{dbb.center}] at (dbb_2.south -| v.center) (a_2) {
            $(b_\mathrm{bc}, \rho_\mathrm{bc})$, $(b_\mathrm{vts}, \rho_\mathrm{vts})$
            };
        \node[block, keep_left, spaced] at (a_2.south -| v.west) (v_2) {
            $h_\mathrm{sec} \gets $ the address of $b_\mathrm{sec}$, \\
            $h_\mathrm{bc} \gets $ the address of $b_\mathrm{bc}$ \\ [7pt]
            verify $\mathsf{AncestryVer}(\{ b_\mathrm{vts}, b_\mathrm{bc} \}, h_\mathrm{sec})$, \\
            $\mathsf{ItemVer}(b_\mathrm{vts}, Y_\mathcal{D})$ and $\mathsf{HistoryVer}(\{ b_\mathrm{vts} \}, h_\mathrm{bc})$
            };
        
        % Arrows and lines
        \draw[dashed] (v.south west)--(dbb.south east);    
        \draw[dashed] (dbb_ik.south -| v.west)--(dbb_ik.south east);

        \draw[dotted] (b_1.north west)--(b_1.north east);
        \draw[dotted] (b_1.south west)--(b_1.south east);

        \draw[densely dotted] (v_1.south -| v.center)--(b_1.north -| v.center);
        \draw[densely dotted] (b_1.south -| v.center)--(v_2.north -| v.center);

        \draw[densely dotted] (a_1.south east)--(dbb_1.north -| dbb.center);
        \draw[densely dotted] (dbb_1.south -| dbb.center)--(b_1.north -| dbb.center);
        \draw[densely dotted] (b_1.south -| dbb.center)--(dbb_2.north -| dbb.center);
        \draw[densely dotted] (dbb_2.south -| dbb.center)--(a_2.south east);
        }
    \end{tikzpicture}
    \caption{Encrypted ballot submission protocol}
    \label{fig: encrypted ballot submission protocol}
\end{figure}

The generation process begins by the voting application generating its encryption randomizer $r_\mathrm{v} \in_\mathrm{R} \mathbb{Z}_q$ and computing a commitment to it $c_\mathrm{v} \gets \mathsf{Com}(r_\mathrm{v}, s_\mathrm{v})$ (\cref{alg: com}), where $s_\mathrm{v} \in_\mathrm{R} \mathbb{Z}_q$. Then, the voting application interacts with the digital ballot box in the protocol \ref{pro: write on board} $\mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{vec}, c_\mathrm{vec}, p_\mathrm{vec})$ in order to append the vote encryption commitment item $b_\mathrm{vec}$ on the board, where $m_\mathrm{vec} =$ "voter encryption commitment", the content $c_\mathrm{vec}$ consists of the commitment $c_\mathrm{v}$ and the parrent $p_\mathrm{vec}$ is the address of the voter session item as received in \cref{sec: voter authentication procedure}. Note that before appending the new item, the bulletin board consists of items $\boldsymbol{b} = \{ b_1, ..., b_{k-1} \}$, therefore $b_\mathrm{vec}$ becoming the $k^\mathrm{th}$ item.

After publishing the voter encryption commitment item on the bulletin board, the digital ballot box imediately geterates its own set of encryption randomizer $r_\mathrm{d} \in_\mathrm{R} \mathbb{Z}_q$ and commitment $c_\mathrm{d} \gets \mathsf{Com}(r_\mathrm{d}, s_\mathrm{d})$ (\cref{alg: com}), where $s_\mathrm{d} \in_\mathrm{R} \mathbb{Z}_q$. Then, it self writes a server encryption commitment item $b_\mathrm{sec}$ on the board by running protocol \ref{pro: write on board} $\mathtt{WriteOnBoard}(\mathcal{D}, m_\mathrm{sec}, c_\mathrm{sec}, p_\mathrm{sec})$, where $m_\mathrm{sec} =$ "server encryption commitment", the content $c_\mathrm{sec}$ consists of its commitment $c_\mathrm{d}$ and the parrent $p_\mathrm{sec}$ is the address of the voter encryption commitment item $b_\mathrm{vec}$.

Next, the digital ballot box returns to the voting application both items $b_\mathrm{vec}$ and $b_\mathrm{sec}$ together with their respective receipts, according to the protocol \ref{pro: write on board} described in \cref{sec: writing on the bulletin board} and the empty cryptogram $e_\mathrm{d}$, i.e. an encryption of the neutral point $\mathcal{O}$ using the encryption randomizer $r_\mathrm{d}$. The voting application performs the validation of the board items $b_\mathrm{vec}$ and $b_\mathrm{sec}$ according to the protocol \ref{pro: write on board} and continues if sucessful.

After both parties have published their encryption commitment items, as presented in \cref{fig: encrypted ballot submission protocol}, the voting application encrypts the voter's encoded vote $M$ (as constructed in \cref{sec: mapping vote options on the elliptic curve}) by computing $e_\mathrm{v} \gets \mathsf{Enc}(Y_\mathrm{enc}, M; r_\mathrm{v})$ (\cref{alg: enc}). This gets further combined with the empty cryptogram received form the digital ballot box, to produce the voter's final ballot cryptogram $e \gets \mathsf{HomAdd}(e_\mathrm{v}, e_\mathrm{d})$ (\cref{alg: hom add}). The voting application also computes a proof of correct encryption $PK \gets \mathsf{DLProve}(r_\mathrm{v})$ (\cref{alg: dl prove}) that confirms the fact that the empty cryptogram $e_\mathrm{d}$ has been used in computation of the final ballot cryptogram $e$.

Finally, the voting application interacts with the digital ballot box in the protocol $\mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{bc}, c_\mathrm{bc}, p_\mathrm{bc})$ (protocol \ref{pro: write on board}) in order to append the ballot cryptogram item $b_\mathrm{bc}$ on the board, where $m_\mathrm{bc} =$ "ballot cryptograms", the content $c_\mathrm{bc}$ consists of the cryptogram $e$ and the parrent $p_\mathrm{bc}$ is the address of the server encryption commitment item $b_\mathrm{sec}$. Note that this time, the bulletin board consists of items $\boldsymbol{b'} = \{ b_1, ..., b_{k'-1} \}$, where $k' \geq k$ as more items could have been appended by other voters in between protocols from \cref{fig: encryption commitments submission protocol} and \cref{fig: encrypted ballot submission protocol}, therefore $b_\mathrm{bc}$ becoming the ${k'}^\mathrm{th}$ item.

Additionally, the voting application submits the proof $PK$ to the digitla ballot box, which performs protocol \ref{pro: write on board} if $\mathsf{DLVer}(PK, \{ G \}, \{ R - [r_\mathrm{d}]G \})$ (\cref{alg: dl ver}) succeeds, where the content of the item  $c_\mathrm{bc}$ consists of $e = (R, C)$.

After publishing the ballot cryptograms item on the bulletin board, the digital ballot box imediately self writes a verification track start item $b_\mathrm{vts}$ on the hidden track of the bulletin board $\boldsymbol{b}^{b_\mathrm{bc}}$ by running $\mathtt{WriteOnBoard}(\mathcal{D}, m_\mathrm{vts}, c_\mathrm{vts}, p_\mathrm{vts})$ (protocol \ref{pro: write on board}), where $m_\mathrm{vts} =$ "verification track start", the content $c_\mathrm{sec}$ is empty and the parrent $p_\mathrm{vts}$ is the address of the ballot cryptogram item $b_\mathrm{bc}$. Note that at this point, the hidden track contains $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts} \}$.

Next, the digital ballot box returns to the voting application both items $b_\mathrm{bc}$ and $b_\mathrm{vts}$ together with their respective receipts, according to the protocol \ref{pro: write on board}. The voting application performs the validation of the two board items according to the protocol \ref{pro: write on board}. In addition, it checks that the verification track start item is the only item on the hidden track by $\mathsf{HistoryVer}(\{ b_\mathrm{vts} \}, h_\mathrm{bc})$ (\cref{alg: history ver}), where $h_\mathrm{bc}$ is the address of the ballot cryptograms item.

Note that, the cryptogram $e$ is actually equivalent to $\mathsf{Enc}(Y_\mathrm{enc}, M; r)$, where $r = r_\mathrm{v} + r_\mathrm{d}$. Both the voter and the digital ballot box know part of the randomizer value, $r_\mathrm{v}$ and $r_\mathrm{d}$ respectively, but neither of them knows the combined value $r$.


\subsubsection{Challenging a vote cryptogram} \label{sec: challenging a vote cryptogram}
After encrypting a ballot, the voter $\mathcal{V}_i$ can choose whether to test or cast it. To perform the testing process of an encrypted ballot, the voter needs to interact with the \textit{external verifier} that will perform all the testing operations on behalf of the voter, according to the data published on the bulletin board. At the end of the testing process, the voter will be presented with the vote choice(s) that were encoded in the encrypted ballot. When doing the testing procedure, the encrypted ballot that is being tested gets spoiled. Therefore, the voter needs to redo the vote cryptogram generation process from \cref{sec: vote cryptogram generation process} to get a new encrypted ballot, which the voter has to choose again whether to test or to cast. This process can be repeated until the voter trusts the legitimacy of the next encrypted ballot generated by the voting application. The protocol is inspired from \cite{Benaloh06}.

The first part of the protocol (\cref{fig: external verifier setup protocol}) establishes a trusted connection amongst the voting application and the external verifier over the bulletin board. The voter inputs into the external verifier the address of the verification track start item $b_\mathrm{vts}$, which queries the digital ballot box for the item at that address and its ancestry. The digital ballot box returns $\alpha_\mathrm{vts} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc}, b_\mathrm{vts} \}$, which consists of all the configuration items (e.g. the genesis item, election configuration items, contest configuration items, etc.) plus all the voting items that are relevant to voter $\mathcal{V}_i$. Notice that all configuration and voting items are on the public bulletin board (i.e. $\alpha_\mathrm{cnf}, b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc} \in \boldsymbol{b}$), except the verification track start item $b_\mathrm{vts}$ which exists on the hidden track $\boldsymbol{b}^{b_\mathrm{bc}}$ that has been spawned by the ballot cryptograms item $b_\mathrm{bc}$.

The external verifier validates the list by running $\mathsf{AncestryVer}(\alpha_\mathrm{vts}, \varnothing)$ (\cref{alg: ancestry ver}), therefore checking that $\alpha_\mathrm{vts}$ has a consistent ancestry all the way through the genesis item, with has no parent, therefore the parent of the entire ancestry is null or $\varnothing$. The external verifier also checks the integrity of every item by $\mathsf{ItemVer}(b_j, Y_\mathcal{W})$ (\cref{alg: item ver}), where $b_j \in \alpha_\mathrm{vts}$ and $Y_\mathcal{W}$ is the public key of the respective writer, according to the rules from \cref{app: bulletin board item types}. Note that the set of writers, as presented in \cref{sec: public bulletin board}, consists of the voter $\mathcal{V}_i$, the digital ballot box $\mathcal{D}$, the election administrator $\mathcal{E}$ and the voter authorizer $\mathcal{A}$. The external verifier can extract the voter's public key $Y_i$ from the voter session item $b_\mathrm{vs}$ and the other public keys $Y_\mathcal{D}$, $Y_\mathcal{E}$ and $Y_\mathcal{A}$ from the configuration items. If valid, the external verifier notifies the voter that the ballot was successfully found.

Then, the voter chooses to test the encryption of the ballot, so the voting application interacts with the digital ballot box in $\mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{sr}, c_\mathrm{sr}, p_\mathrm{sr})$ (protocol \ref{pro: write on board}) to append the spoil request item $b_\mathrm{sr}$ on the board, where $m_\mathrm{sr} = $ "spoil request", the content $c_\mathrm{sr}$ is empty and the parent $p_\mathrm{sr}$ is the address of the ballot cryptograms item $b_\mathrm{bc}$.

After publishing the spoil request item $b_\mathrm{sr}$, the digital ballot box sends the new item also to the external verifier, which verifies its integrity $\mathsf{ItemVer}(b_\mathrm{sr}, Y_i)$ (\cref{alg: item ver}) and that it is consistent with the ancestry $\mathsf{AncestryVer}(\{ b_\mathrm{sr} \}, h_\mathrm{bc})$ (\cref{alg: ancestry ver}), where $h_\mathrm{bc}$ is the address of the ballot cryptograms item $b_\mathrm{bc}$. If valid, the external verifier generates its own key pair $(x_\mathcal{X}, Y_\mathcal{X}) \gets \mathsf{KeyGen}()$ (\cref{alg: key gen}) and interacts with digital ballot box in $\mathtt{WriteOnBoard}(\mathcal{X}, m_\mathrm{v}, c_\mathrm{v}, p_\mathrm{v})$ (protocol \ref{pro: write on board}) to write a verifier item $b_\mathrm{v}$ on the hidden track, where $m_\mathrm{v} =$ "verifier", the content $c_\mathrm{v}$ contains the external verifier's public key $Y_\mathcal{X}$ and the parent $p_\mathrm{v}$ is the address of the spoil request item $b_\mathrm{sr}$. Note that the verifier item $b_\mathrm{v}$ is appended on the hidden track introduces by the ballot cryptograms item $b_\mathrm{bc}$. Therefore, at the end of this step, the hidden track consists of $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts}, b_\mathrm{v} \}$. From this point on, the external verifier represents indentity $\mathcal{X}$ on the hidden track $\boldsymbol{b}^{b_\mathrm{bc}}$.

The protocol continues with \cref{fig: commitment opening submisson protocol} where the external verifier returns to the voter with the address of the verifier item $h_\mathrm{v}$. The voter also receives the verifier item $b_\mathrm{v}$ from the digital ballot box. The voter checks the integrity of the item $\mathsf{ItemVer}(b_\mathrm{v}, Y_\mathcal{X})$ (\cref{alg: item ver}) and that it is consistent with the ancestry $\mathsf{AncestryVer}(\{ b_\mathrm{v} \}, h_\mathrm{vts})$ (\cref{alg: ancestry ver}), where $Y_\mathcal{X}$ is extracted from the content of the verifier item and $h_\mathrm{vts}$ is the address of the verification track start item. Then the voter checks that the address received from the external verifier is consistent with the verifier item received from the digital ballot box. If valid, the voter managed to establish a trusted connection with the external verifier over the bulletin board, therefore the protocol can continue.

Next, both the voter and the digital ballot box collaborate to deliver to the external verifier, in a secure manner, their encryption randomizer $r_\mathrm{v}$ and $r_\mathrm{s}$ respectively, as generated in \cref{sec: vote cryptogram generation process}. The external verifier will use them to decrypt the voter's ballot cryptograms and present the vote choices to the voter for assessment.

This is achieved by the voter encrypting (using standard symmetric key encryption) the randomizer and the commitment opening $d_\mathrm{v} \gets \mathsf{TxtEnc}(r_\mathrm{v} || s_\mathrm{v}, k_\mathrm{v})$ (\cref{alg: txt enc}), where $k_\mathrm{v}$ is a derrived key based on Diffie-Hellmann key exchange protocol between the voter and the external verifier, i.e. $k_\mathrm{v} \gets \mathsf{DHKDF}(x_i, Y_\mathcal{X})$. Then, the voter interacts with the digital ballot box to write the voter commitment opening item $b_\mathrm{vco}$ on the hidden track $\mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{vco}, c_\mathrm{vco}, p_\mathrm{vco})$ (protocol \ref{pro: write on board}), where $m_\mathrm{vco} = $ "voter commitment opening", content $c_\mathrm{vco}$ consists of the encryption $d_\mathrm{v}$ and the parent $p_\mathrm{v}$ is the address of the verifier item $b_\mathrm{v}$.

After publishing the voter commitment opening item, the digital ballot box imediately computes its own encryption of the randomizer are commitment opening $d_\mathrm{d}$ using the same strategy as the voter in the previous paragraph. Then, it self writes a server commitment opening item $b_\mathrm{sco}$ on the board by running $\mathtt{WriteOnBoard}(\mathcal{D}, m_\mathrm{sco}, c_\mathrm{sco}, p_\mathrm{sco})$ (protocol \ref{pro: write on board}), where $m_\mathrm{sco} =$ "server commitment opening", the content $c_\mathrm{sec}$ consists of the encryption $d_\mathrm{d}$ and the parrent $p_\mathrm{sco}$ is the address of the voter commitment opening item $b_\mathrm{vco}$. 

Then (\cref{fig: unpacking the encrypted ballot protocol}), the external verifier is notified about both commitment opening items, which verifies the integrity of them and that they are consistent with the previous ancestry. If valid, it decrypts (using standard symmetric key decryption) both commitment openings, of the voter $(r_\mathrm{v}, s_\mathrm{v}) \gets \mathsf{TxtDec}(d_\mathrm{v}, k_\mathrm{v})$ (\cref{alg: txt dec}) and of the digital ballot box $(r_\mathrm{d}, s_\mathrm{d}) \gets \mathsf{TxtDec}(d_\mathrm{d}, k_\mathrm{d})$, where the encryptions $d_\mathrm{v}$ and $d_\mathrm{d}$ are extracted from the content of the voter and of the server commitment opening itmes respectively, and the symmetric keys $k_\mathrm{v}$ and $k_\mathrm{d}$ are computed based on the Diffie-Hellmann key exchange protocol between the external verifier and the voter or the digital ballot box respectively.

Next, the external verifier checks whether the commitment openings are consistent with the commitments that were published in \cref{sec: vote cryptogram generation process}, i.e. verification of the voter commitment $\mathsf{ComVer}(c_\mathrm{v}, r_\mathrm{v}, s_\mathrm{v})$ (\cref{alg: com ver}) and of the server commitment $\mathsf{ComVer}(c_\mathrm{d}, r_\mathrm{d}, s_\mathrm{d})$, where commitments $c_\mathrm{v}$ and $c_\mathrm{d}$ are extracted from the voter and server encryption commitment items respectively. If commitments are validated, the external verifier proceeds to the unpacking of the cryptogram $e$, which is extarcted from the ballot cryptograms items $b_\mathrm{bc}$. If any of the validations fail, the external verifier informs the voter about the failure.

The external verifier unpacks the vote $V'$ by decrypting a variant of the cryptogram $e = (R, C)$, where point $R$ is substituted by the encryption key $Y_\mathrm{enc}$, such that it can be decrypted by the randomizer $r_\mathrm{v} + r_\mathrm{d}$ instead of the decryption key. Note that, the encryption key $Y_\mathrm{enc}$ can be extracted form the threshold configuration item, which is part of $\alpha_\mathrm{cnf}$. Formally, $V' \gets \mathsf{Dec}(r_\mathrm{v} + r_\mathrm{d}, e')$ (\cref{alg: dec}), where $e' \gets (Y_\mathrm{enc}, C)$.

Finally, the external veryfier presents to the voter, the plain text vote $V'$, which can compare to the original vote choice $V$, as computed in \cref{sec: mapping vote options on the elliptic curve}. Note that $V'$ can even be decoded into a human readable presentation of the vote choices by converting it to bytes $\mathsf{Point2Bytes}(V')$ (\cref{alg: point to bytes}) and then into a plaintext vote according to the configuration from $\alpha_\mathrm{cnf}$. If the vote matches, then the voter is assured that the voting application behaved correctly (i.e. it encrypted a genuine vote). Otherwise, the voter has evidence that the voting application has misbehaved during the process and should act accordingly.

\clearpage
\begin{landscape}
\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[framed, node distance=0,
            % every node/.style={draw},
            ]{
        
        % Actors
        \node[title_3, above, anchor=north east] (v) {
            \textbf{Voter $\mathcal{V}_i$}};
        \node[title_3, text width=135, right=of v] (ev) {
            \textbf{External Verifier $\mathcal{X}$}};
        \node[title_3, text width=211, right=of ev] (dbb) {
            \textbf{Digital Ballot Box $\mathcal{D}$}};

        % internal knowledge
        \node[internal_3, below=of v] (v_ik) {
            internal knowledge: $x_i$, $Y_\mathcal{D}$, \\
            $\alpha_\mathrm{vts} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc}, b_\mathrm{vts} \}$
            };
        \node[internal_3, text width=135, below=of ev] (ev_ik) {
            no internal knowledge
            };
        \node[internal_3, text width=211, below=of dbb] (dbb_ik) {
            internal knowledge: $x_\mathcal{D}$, $\boldsymbol{b} = \{ b_1, ..., b_{k-1} \}$, \\
            $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts} \}$, where $\alpha_\mathrm{cnf}, \{ b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc} \} \subset \boldsymbol{b}$
            };
        
        % All content
        \node[arrow, towards_right, spaced, between={v.center}{ev.center}] at (dbb_ik.south -| v.center) (a_1) {
            address of $b_\mathrm{vts}$
            };
        \node[arrow, towards_right, immediate, between={ev.center}{dbb.center}] at (a_1.south -| ev.center) (a_2) {
            address of $b_\mathrm{vts}$
            };
        \node[arrow, towards_left, spaced, between={ev.center}{dbb.center}] at (a_2.south -| ev.center) (a_3) {
            $\alpha_\mathrm{vts} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc}, b_\mathrm{vts} \}$
            };
        \node[block, keep_left, spaced] at (a_3.south -| ev.west) (ev_1) {
            $Y_i = $ the content of $b_\mathrm{vs}$, $\{ Y_\mathcal{D}, Y_\mathcal{E}, Y_\mathcal{A} \} = $ the contents of $\alpha_\mathrm{cnf}$ \\
            verify $\mathsf{AncestryVer}(\alpha_\mathrm{vts}, \varnothing)$ and $\mathsf{ItemVer}(b_j, Y_\mathcal{W})$ for each $b_j \in \alpha_\mathrm{vts}$, \\
            where $\mathcal{W} \in \{ \mathcal{D}, \mathcal{E}, \mathcal{A}, \mathcal{V}_i \}$ according to rules form \cref{app: bulletin board item types}
            };
        \node[arrow, towards_left, immediate, between={v.center}{ev.center}] at (ev_1.south -| v.center) (a_4) {
            "ballot found" \hspace{60pt}
            };
        \node[block, keep_left, spaced] at (a_4.south -| v.west) (v_1) {
            $m_\mathrm{sr} \gets $ "spoil request", $c_\mathrm{sr} \gets \varnothing$, $p_\mathrm{sr} \gets$ address of $b_\mathrm{bc}$
            };
        \node[banner, keep_left, spaced, between={v.west}{dbb.east}] at (v_1.south -| v.west) (b_1) {
            $\mathcal{V}_i$ and $\mathcal{D}$ perform protocol \ref{pro: write on board} to write $b_\mathrm{sr}$ as the $k^\mathrm{th}$ item of $\boldsymbol{b}$ \\
            $(b_\mathrm{sr}, \rho_\mathrm{sr}) \gets \mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{sr}, c_\mathrm{sr}, p_\mathrm{sr})$, therefore $b_\mathrm{sr} \in \boldsymbol{b}$
            };
        \node[arrow, towards_left, between={ev.center}{dbb.center}] at (b_1.south -| ev.center) (a_5) {
            $b_\mathrm{sr}$
            };
        \node[block, keep_left, spaced] at (a_5.south -| ev.west) (ev_2) {
            $h_\mathrm{bc} \gets$ the address of $b_\mathrm{bc}$ \\
            verify $\mathsf{AncestryVer}(\{ b_\mathrm{sr} \}, h_\mathrm{bc})$ and $\mathsf{ItemVer}(b_\mathrm{sr}, Y_i)$ then: \\ [7pt]

            $(x_\mathcal{X}, Y_\mathcal{X}) \gets \mathsf{KeyGen}()$, \\
            $m_\mathrm{v} \gets$ "verifier", $c_\mathrm{v} \gets Y_\mathcal{X}$, $p_\mathrm{v} \gets$ address of $b_\mathrm{sr}$
            };
        \node[banner, keep_left, spaced, between={ev.west}{dbb.east}] at (ev_2.south -| ev.west) (b_2) {
            $\mathcal{X}$ and $\mathcal{D}$ perform protocol \ref{pro: write on board} to write $b_\mathrm{v}$ as the second item of the hidden track $\boldsymbol{b}^{b_\mathrm{bc}}$ \\
            $(b_\mathrm{v}, \rho_\mathrm{v}) \gets \mathtt{WriteOnBoard}(\mathcal{X}, m_\mathrm{v}, c_\mathrm{v}, p_\mathrm{v})$, threfore $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts}, b_\mathrm{v} \}$
            };
        \node[anchor=north] at (b_2.south -| v.center) (bottom){};
        
        % Arrows and lines
        \draw[dashed] (v.south west)--(dbb.south east);    
        \draw[dashed] (dbb_ik.south -| v_ik.west)--(dbb_ik.south east);

        \draw[dotted] (b_1.north west)--(b_1.north east);
        \draw[dotted] (b_1.south west)--(b_1.south east);
        \draw[dotted] (b_2.north west)--(b_2.north east);
        \draw[dotted] (b_2.south west)--(b_2.south east);
        
        \draw[densely dotted] (dbb_ik.south -| v.center)--(v_1.north -| v.center);
        \draw[densely dotted] (v_1.south -| v.center)--(b_1.north -| v.center);
        \draw[densely dotted] (b_1.south -| v.center)--(bottom.south -| v.center);
        
        \draw[densely dotted] (a_1.south -| ev.center)--(ev_1.north -| ev.center);
        \draw[densely dotted] (ev_1.south -| ev.center)--(a_4.south east);
        \draw[densely dotted] (a_5.south west)--(ev_2.north -| ev.center);
        \draw[densely dotted] (ev_2.south -| ev.center)--(b_2.north -| ev.center);
        \draw[densely dotted] (b_2.south -| ev.center)--(bottom.south -| ev.center);
        
        \draw[densely dotted] (a_2.south east)--(a_3.south east);
        \draw[densely dotted] (b_1.south -| dbb.center)--(a_5.south east);
        \draw[densely dotted] (b_2.south -| dbb.center)--(bottom.south -| dbb.center);
        }
    \end{tikzpicture}
    \caption{External verifier setup protocol}
    \label{fig: external verifier setup protocol}
\end{figure}

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[framed, node distance=0,
            % every node/.style={draw},
            ]{
        
        % Actors
        \node[title_3, above, anchor=north east] (v) {
            \textbf{Voter $\mathcal{V}_i$}};
        \node[title_3, right=of v] (ev) {
            \textbf{External Verifier $\mathcal{X}$}};
        \node[title_3, right=of ev] (dbb) {
            \textbf{Digital Ballot Box $\mathcal{D}$}};
        
        % internal knowledge
        \node[internal_3, below=of v] (v_ik) {
            internal knowledge: $x_i$, $Y_\mathcal{D}$, $r_\mathrm{v}$, $s_\mathrm{v}$, \\
            $\alpha_\mathrm{bc} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc} \}$, \\
            $\alpha_\mathrm{vts} = \alpha_\mathrm{bc} \cup \{ b_\mathrm{vts} \}$, $\alpha_\mathrm{sr} = \alpha_\mathrm{bc} \cup \{ b_\mathrm{sr} \}$
            };
        \node[internal_3, below=of ev] (ev_ik) {
            internal knowledge: $x_\mathcal{X}$, \\
            $\alpha_\mathrm{bc} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc} \}$, \\
            $\alpha_\mathrm{v} = \alpha_\mathrm{bc} \cup \{ b_\mathrm{vts}, b_\mathrm{v} \}$, $\alpha_\mathrm{sr} = \alpha_\mathrm{bc} \cup \{ b_\mathrm{sr} \}$
            };
        \node[internal_3, below=of dbb] (dbb_ik) {
            internal knowledge: $x_\mathcal{D}$, $Y_\mathcal{X}$, $r_\mathrm{d}$, $s_\mathrm{d}$, \\
            $\boldsymbol{b}$, $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts}, b_\mathrm{v} \}$
            };
        
        % All content
        \node[arrow, towards_left, spaced, between={v.center}{ev.center}] at (v_ik.south -| v.center) (a_1) {
            $h_\mathrm{v} = $ address of $b_\mathrm{v}$
            };
        \node[arrow, towards_left, immediate, between={v.center}{dbb.center}] at (a_1.south -| v.center) (a_2) {
            \hspace{150pt} $b_\mathrm{v}$
            };
        \node[block, keep_left, spaced] at (a_2.south -| v.west) (v_1) {
            $Y_\mathcal{X} = $ the content of $b_\mathrm{v}$, $h_\mathrm{vts} = $ the address of $b_\mathrm{vts}$ \\
            verify $\mathsf{AncestryVer}(\{ b_\mathrm{v} \}, h_\mathrm{vts})$, $\mathsf{ItemVer}(b_\mathrm{v}, Y_\mathcal{X})$ and address of $b_\mathrm{v} = h_\mathrm{v}$ then: \\ [7pt]
            $k_\mathrm{v} \gets \mathsf{DHKDF}(x_i, Y_\mathcal{X})$, $d_\mathrm{v} \gets \mathsf{TxtEnc}(r_\mathrm{v} || s_\mathrm{v}, k_\mathrm{v})$ \\
            $c_\mathrm{vco} \gets d_\mathrm{v}$, $p_\mathrm{vco} \gets$ address of $b_\mathrm{v}$ \\
            $m_\mathrm{vco} \gets$ "voter commitment opening"
            };
        \node[banner, keep_left, spaced, between={v.west}{dbb.east}] at (v_1.south -| v.west) (b_1) {
            $\mathcal{V}_i$ and $\mathcal{D}$ perform protocol \ref{pro: write on board} to write $b_\mathrm{vco}$ as third item of the hiddne track $\boldsymbol{b}^{b_\mathrm{bc}}$ \\
            $(b_\mathrm{vco}, \rho_\mathrm{vco}) \gets \mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{vco}, c_\mathrm{vco}, p_\mathrm{vco})$, therefore $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts}, b_\mathrm{v}, b_\mathrm{vco} \}$
            };
        \node[block, keep_right, spaced] at (b_1.south east) (dbb_1) {
            $k_\mathrm{d} \gets \mathsf{DHKDF}(x_\mathcal{D}, Y_\mathcal{X})$, $d_\mathrm{d} \gets \mathsf{TxtEnc}(r_\mathrm{d} || s_\mathrm{d}, k_\mathrm{d})$ \\
            $c_\mathrm{sco} \gets d_\mathrm{d}$, $p_\mathrm{sco} \gets$ address of $b_\mathrm{vco}$ \\
            $m_\mathrm{sco} \gets$ "server commitment opening" \\ [7pt]
            \scriptsize perform protocol \ref{pro: write on board} to write $b_\mathrm{sco}$ as the forth item on the \\ [-2pt]
            \scriptsize hidden track $\boldsymbol{b}^{b_\mathrm{bc}}$, therefore $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts}, b_\mathrm{v}, b_\mathrm{vco}, b_\mathrm{sco} \}$ \\ [-2pt]
            \scriptsize $(b_\mathrm{sco}, \rho_\mathrm{sco}) \gets \mathtt{WriteOnBoard}(\mathcal{D}, m_\mathrm{sco}, c_\mathrm{sco}, p_\mathrm{sco})$
            };
        \node[arrow, towards_left, immediate, between={v.center}{dbb.center}] at (dbb_1.south -| v.center) (a_3) {
            $b_\mathrm{vco}$, $b_\mathrm{sco}$ \hspace{100pt}
            };
        \node[block, keep_left, spaced] at (a_3.south -| v.west) (v_2) {
            verify $\mathsf{AncestryVer}(\{ b_\mathrm{vco}, b_\mathrm{sco} \}, h_\mathrm{v})$ and $\mathsf{ItemVer}(b_\mathrm{sco}, Y_\mathcal{D})$
            };
        \node[anchor=north] at (v_2.south -| v.center) (bottom){};
        
        % Arrows and lines
        \draw[dashed] (v.south west)--(dbb.south east);    
        \draw[dashed] (v_ik.south west)--(v_ik.south -| dbb.east);

        \draw[dotted] (b_1.north west)--(b_1.north east);
        \draw[dotted] (b_1.south west)--(b_1.south east);
        
        \draw[densely dotted] (v_ik.south -| v.center)--(v_1.north -| v.center);
        \draw[densely dotted] (v_1.south -| v.center)--(b_1.north -| v.center);
        \draw[densely dotted] (b_1.south -| v.center)--(v_2.north -| v.center);
        \draw[densely dotted] (v_2.south -| v.center)--(bottom.south -| v.center);
        
        \draw[densely dotted] (v_ik.south -| ev.center)--(a_1.south east);
        
        \draw[densely dotted] (v_ik.south -| dbb.center)--(a_2.south east);
        \draw[densely dotted] (b_1.south -| dbb.center)--(dbb_1.north -| dbb.center);
        \draw[densely dotted] (dbb_1.south -| dbb.center)--(bottom.south -| dbb.center);
        }
    \end{tikzpicture}
    \caption{Commitment opening submission protocol}
    \label{fig: commitment opening submisson protocol}
\end{figure}

\clearpage
\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[framed, node distance=0,
            % every node/.style={draw},
            ]{
        
        % Actors
        \node[title_3, above, anchor=north east] (v) {
            \textbf{Voter $\mathcal{V}_i$}};
        \node[title_3, right=of v] (ev) {
            \textbf{External Verifier $\mathcal{X}$}};
        \node[title_3, right=of ev] (dbb) {
            \textbf{Digital Ballot Box $\mathcal{D}$}};
        
        % internal knowledge
        \node[internal_3, below=of v] (v_ik) {
            internal knowledge: $V$
            };
        \node[internal_3, below=of ev] (ev_ik) {
            internal knowledge: $x_\mathcal{X}$, $Y_i$, $Y_\mathcal{D}$, \\
            $\alpha_\mathrm{v} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc}, b_\mathrm{vts}, b_\mathrm{v} \}$
            };
        \node[internal_3, below=of dbb] (dbb_ik) {
            internal knowledge: $x_\mathcal{D}$, \\
            $\boldsymbol{b}$, $\boldsymbol{b}^{b_\mathrm{bc}} = \{ b_\mathrm{vts}, b_\mathrm{v}, b_\mathrm{vco}, b_\mathrm{sco} \}$
            };
        
        % All content
        \node[arrow, towards_left, spaced, between={ev.center}{dbb.center}] at (dbb_ik.south -| ev.center) (a_1) {
            $b_\mathrm{vco}$, $b_\mathrm{sco}$
            };
        \node[block, keep_middle, spaced] at (a_1.south -| ev.center) (ev_1) {
            verify $\mathsf{AncestryVer}(\{ b_\mathrm{vco}, b_\mathrm{sco} \}, h_\mathrm{v})$, \\
            $\mathsf{ItemVer} (b_\mathrm{vco},Y_i)$ and $\mathsf{ItemVer} (b_\mathrm{sco},Y_\mathcal{D})$ then: \\ [7pt]
            $d_\mathrm{v} = $ the content of $b_\mathrm{vco}$, $d_\mathrm{d} = $ the content of $b_\mathrm{sco}$ \\
            $c_\mathrm{v} = $ the content of $b_\mathrm{vec}$, $c_\mathrm{d} = $ the content of $b_\mathrm{sec}$ \\
            $e = (R, C) = $ the content of $b_\mathrm{bc}$ \\
            $Y_\mathrm{enc} = $ the contents of $\alpha_\mathrm{cnf}$ \\
            $k_\mathrm{v} \gets \mathsf{DHKDF}(x_\mathcal{X}, Y_i)$, $(r_\mathrm{v}, s_\mathrm{v}) \gets \mathsf{TxtDec}(d_\mathrm{v}, k_\mathrm{v})$ \\
            $k_\mathrm{d} \gets \mathsf{DHKDF}(x_\mathcal{X}, Y_\mathcal{D})$, $(r_\mathrm{d}, s_\mathrm{d}) \gets \mathsf{TxtDec}(d_\mathrm{d}, k_\mathrm{d})$ \\ [7pt]
            verify that $\mathsf{ComVer}(c_\mathrm{v}, r_\mathrm{v}, s_\mathrm{v})$
            and $\mathsf{ComVer}(c_\mathrm{d}, r_\mathrm{d}, s_\mathrm{d})$ then: \\ [7pt]
            $r' \gets r_\mathrm{v} + r_\mathrm{d}$, $e' \gets (Y_\mathrm{enc}, C)$, $V' \gets \mathsf{Dec}(r', e')$
            };
        \node[arrow, towards_left, between={v.center}{ev.center}] at (ev_1.south -| v.center) (a_2) {
            $V'$
            };
        \node[block, keep_middle, spaced] at (a_2.south -| v.center) (v_1) {
            verify that $V = V'$
            };
        
        % Arrows and lines
        \draw[dashed] (v.south west)--(dbb.south east);    
        \draw[dashed] (dbb_ik.south -| v.west)--(dbb_ik.south east);
        
        \draw[densely dotted] (dbb_ik.south -| v.center)--(v_1.north -| v.center);
        
        \draw[densely dotted] (a_1.south west)--(ev_1.north -| ev.center);
        \draw[densely dotted] (ev_1.south -| ev.center)--(a_2.south -| ev.center);
        
        \draw[densely dotted] (dbb_ik.south -| dbb.center)--(a_1.south east);
        }
    \end{tikzpicture}
    \caption{Unpacking the encrypted ballot protocol}
    \label{fig: unpacking the encrypted ballot protocol}
\end{figure}
\end{landscape}


\clearpage
\subsubsection{Vote confirmation receipt} \label{sec: vote confirmation receipt}
After encrypting a ballot, the voter $\mathcal{V}_i$ can choose whether to test or cast it. After choosing cast the ballot, the voter receives a receipt from the digital ballot box that confirms that the ballot has been registered as cast on hte public bulletin board. 

The voter has to follow the protocol from \cref{fig: ballot casting protocol} where the voting application interacts with the digital ballot box in $\mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{cr}, c_\mathrm{cr}, p_\mathrm{cr})$ (protocol \ref{pro: write on board}) in order to append the cast request item $b_\mathrm{cr}$ on the board, where $m_\mathrm{cr} =$ "cast request", the content $c_\mathrm{cr}$ is empty and the parrent $p_\mathrm{cr}$ is the address of the ballot cryptograms item $b_\mathrm{bc}$.

After publishing the cast request item on the bulletin board, the digital ballot box return to the voting app with the item $b_\mathrm{cr}$ and its receipt $\rho_\mathrm{cr}$. The voting app checks the item according to validations of protocol \ref{pro: write on board} and if valid, the voting application presents the receipt $\rho_\mathrm{cr}$ together with $\sigma_\mathrm{cr}$ and $h_\mathrm{cr}$ to the voter.

The voter stores the tuple as the vote confirmation receipt (i.e. proof of the ballot being cast on the bulletin board). The voter can use it at any time to check that the vote is registered on the bulletin board as described in \cref{sec: vote is registered as cast}.

Note that, if a voter $\mathcal{V}_i$ has a vote confirmation receipt $(\rho_\mathrm{cr}, \sigma_\mathrm{cr}, h_\mathrm{cr})$ that is valid (i.e. $\mathsf{SigVer}(Y_\mathcal{D}, \rho_\mathrm{cr}; \sigma_\mathrm{cr} || h_\mathrm{cr})$, where $Y_\mathcal{D}$ exists on the bulletin board $\boldsymbol{b}$) but does not correspond with the current state of the bulletin board (i.e. $h_\mathrm{cr}$ is not the address of any item of the bulletin board $\boldsymbol{b}$), that reveals that the integrity of the bulletin board has been broken and should be reported to the election officials.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[framed, node distance=0,
            % every node/.style={draw}
            ]{

        % Actors
        \node[title, above, anchor=north east] (v) {
            \textbf{Voter} $\mathcal{V}_i$};
        \node[title, right=of v] (dbb) {
            \textbf{Digital Ballot Box} $\mathcal{D}$};
        
        % internal knowledge
        \node[internal, below=of v] (v_ik) {
            internal knowledge: $x_i$, $Y_\mathcal{D}$, \\
            $\alpha_\mathrm{bc} = \alpha_\mathrm{cnf} \cup \{ b_\mathrm{vs}, b_\mathrm{vec}, b_\mathrm{sec}, b_\mathrm{bc} \}$
            };
        \node[internal, below=of dbb] (dbb_ik) {
            internal knowledge: $x_\mathcal{D}$, \\
            $\boldsymbol{b} = \{ b_1, ..., b_{k-1} \}$, where $\alpha_\mathrm{bc} \subset \boldsymbol{b}$
            };
        
        %All content
        \node[block, keep_left, spaced] at (dbb_ik.south -| v.west) (v_1) {
            $c_\mathrm{cr} \gets \varnothing$, $p_\mathrm{cr} \gets$ the address of $b_\mathrm{bc}$ \\
            $m_\mathrm{cr} \gets$ "cast request"
            };
        \node[banner, keep_left, spaced, between={v.west}{dbb.east}] at (v_1.south -| v.west) (b_1) {
            $\mathcal{V}_i$ and $\mathcal{D}$ perform protocol \ref{pro: write on board} to write $b_\mathrm{cr}$ as the $k^\mathrm{th}$ item of $\boldsymbol{b}$ \\
            $(b_\mathrm{cr}, \rho_\mathrm{cr}) \gets \mathtt{WriteOnBoard}(\mathcal{V}_i, m_\mathrm{cr}, c_\mathrm{cr}, p_\mathrm{cr})$, therefore $b_\mathrm{cr} \in \boldsymbol{b}$
            };
        \node[block, keep_left, spaced] at (b_1.south -| v.west) (v_2) {
            store $\rho_\mathrm{cr}$ as the vote receipt
            };
        
        % Arrows and lines
        \draw[dashed] (v.south west)--(dbb.south east);    
        \draw[dashed] (dbb_ik.south -| v.west)--(dbb_ik.south east);

        \draw[dotted] (b_1.north west)--(b_1.north east);
        \draw[dotted] (b_1.south west)--(b_1.south east);
        
        \draw[densely dotted] (v_1.south -| v.center)--(b_1.north -| v.center);
        \draw[densely dotted] (b_1.south -| v.center)--(v_2.north -| v.center);
        }
    \end{tikzpicture}
    \caption{Ballot casting protocol}
    \label{fig: ballot casting protocol}
\end{figure}
